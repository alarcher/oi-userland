--- torque-6.1.0.orig/src/daemon_client/trq_auth_daemon.c	2017-01-20 20:33:25.782130727 +0100
+++ torque-6.1.0/src/daemon_client/trq_auth_daemon.c	2017-01-21 01:44:37.347777856 +0100
@@ -349,7 +349,7 @@
     }
 
   mypid = getpid();
-  sprintf(write_buf, "%d|%d|%s|%d|", TRQ_DOWN_TRQAUTHD, (int )strlen(pwent->pw_name), pwent->pw_name, mypid);
+  sprintf(write_buf, "%d|%d|%s|%ld|", TRQ_DOWN_TRQAUTHD, (int )strlen(pwent->pw_name), pwent->pw_name, mypid);
 
   if((rc = connect_to_trqauthd(&sock)) != PBSE_NONE)
     {
--- torque-6.1.0.orig/src/include/mom_func.h	2017-01-20 20:33:26.121409126 +0100
+++ torque-6.1.0/src/include/mom_func.h	2017-01-21 01:44:37.348060336 +0100
@@ -252,7 +252,9 @@
 extern void  state_to_server(int, int);
 extern void  dep_main_loop_cycle(void);
 extern int   message_job(job *, enum job_file, char *);
+#ifndef __sun
 extern proc_stat_t *get_proc_stat(int pid);
+#endif
 
 extern void  term_job(job *);
 int          TTmpDirName(job *, char *, int);
--- torque-6.1.0.orig/src/lib/Libattr/attr_node_func.c	2017-01-20 20:33:26.166328978 +0100
+++ torque-6.1.0/src/lib/Libattr/attr_node_func.c	2017-01-21 01:44:37.348634700 +0100
@@ -830,7 +830,11 @@
   long offset = 0;
   if (offsetGiven)
     {
+#if defined(__sun) && defined(__SVR4)
+    offset = (tm.tm_isdst > 0 ? altzone : timezone); //Save the offset, mktime puts in its own.
+#else
     offset = tm.tm_gmtoff; //Save the offset, mktime puts in its own.
+#endif
     }
   time_t givenEpoch = mktime(&tm);
   if (offsetGiven)
@@ -842,12 +846,20 @@
        Time entered 2014-08-20T00:00:00-04
        Machine on west coast will see that as 2014-08-19T20:00:00-08
        */
+#if defined(__sun) && defined(__SVR4)
+    givenEpoch += (tm.tm_isdst > 0 ? altzone : timezone); //Take away the calculated offset.
+#else
     givenEpoch += tm.tm_gmtoff; //Take away the calculated offset.
+#endif
     givenEpoch -= offset;       //Add in the passed in offset.
     }
   else
     {
+#if defined(__sun) && defined(__SVR4)
+    givenEpoch += (tm.tm_isdst > 0 ? altzone : timezone); //Take away the calculated offset.
+#else
     givenEpoch += tm.tm_gmtoff; //Take away the calculated offset.
+#endif
     }
   if(givenEpoch <= time(NULL))
     {
--- torque-6.1.0.orig/src/lib/Libifl/pbsD_connect.c	2017-01-20 20:33:26.161194808 +0100
+++ torque-6.1.0/src/lib/Libifl/pbsD_connect.c	2017-01-21 01:44:37.349068632 +0100
@@ -110,6 +110,10 @@
 #if HAVE_SYS_UIO_H
 #include <sys/uio.h>
 #endif
+#ifdef __sun
+#include <sys/sockio.h>
+#undef s_addr
+#endif
 
 #include <unistd.h>
 #include <fcntl.h>
@@ -704,7 +708,7 @@
      * trq_system|trq_port|Validation_type|user|pid|psock|
      */
     mypid = getpid();
-    sprintf(write_buf, "%d|%d|%s|%d|%d|%d|%s|%d|%d|", TRQ_AUTH_CONNECTION, (int)strlen(server_name), server_name, server_port, AUTH_TYPE_IFF, (int)strlen(pwent->pw_name), pwent->pw_name, mypid, parent_client_socket);
+    sprintf(write_buf, "%d|%d|%s|%d|%d|%d|%s|%ld|%d|", TRQ_AUTH_CONNECTION, (int)strlen(server_name), server_name, server_port, AUTH_TYPE_IFF, (int)strlen(pwent->pw_name), pwent->pw_name, mypid, parent_client_socket);
     /*
      * total_length|val
      */
--- torque-6.1.0.orig/src/lib/Libifl/tm.c	2017-01-20 20:33:26.157253857 +0100
+++ torque-6.1.0/src/lib/Libifl/tm.c	2017-01-21 01:44:37.349549337 +0100
@@ -81,8 +81,10 @@
 #include <pbs_config.h>   /* the master config generated by configure */
 
 /* define the following so we get prototype for getsid() */
+#ifndef __sun
 #define _XOPEN_SOURCE
 #define _XOPEN_SOURCE_EXTENDED 1
+#endif
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -179,7 +181,7 @@
   struct stat sbuf;
 
   /* build path to pid */
-  snprintf(path, sizeof(path), "/proc/%d", pid);
+  snprintf(path, sizeof(path), "/proc/%ld", pid);
 
   /* do the stat */
   /*   if it fails, assume not owner */
--- torque-6.1.0.orig/src/lib/Libifl/trq_auth.c	2017-01-20 20:33:26.160040795 +0100
+++ torque-6.1.0/src/lib/Libifl/trq_auth.c	2017-01-21 01:44:37.349979470 +0100
@@ -21,6 +21,10 @@
 #include <string.h>
 #include <string>
 
+#if defined(__sun) && defined(__SVR4)
+#include <ucred.h>
+#endif
+
 #define MAX_RETRIES 5
 
 char         *trq_addr = NULL;
@@ -646,8 +650,16 @@
   char       *msg)
 
   {
+
+#if defined(__sun) && defined(__SVR4)
+  ucred_t * cr;
+  uid_t euid;
+  gid_t gid;
+  pid_t pid;
+#else
   struct ucred   cr;
   socklen_t      cr_size;
+#endif
   struct passwd *user_pwd;
   char *buf;
 
@@ -660,6 +672,52 @@
     return(PBSE_BAD_PARAMETER);
     }
 
+#if defined(__sun) && defined(__SVR4)
+  if (getpeerucred(sock, &cr) == -1)
+    {
+    sprintf(msg, "getpeerucred failed: %d", errno);
+    return(PBSE_SOCKET_FAULT);
+    }
+  if ((euid = ucred_geteuid(cr)) == (uid_t)-1)
+    {
+    sprintf(msg, "ucred_geteuid failed: %d", errno);
+    return(PBSE_SOCKET_FAULT);
+    }
+  if ((gid = ucred_getrgid(cr)) == (gid_t)-1)
+    {
+    sprintf(msg, "ucred_getrgid failed: %d", errno);
+    return(PBSE_SOCKET_FAULT);
+    }
+  if ((pid = ucred_getpid(cr)) == (pid_t)-1)
+    {
+    sprintf(msg, "ucred_getpid failed: %d", errno);
+    return(PBSE_SOCKET_FAULT);
+    }
+
+  user_pwd = get_password_entry_by_uid(&buf, euid);
+
+  if (user_pwd == NULL)
+    {
+    sprintf(msg, "UID %d returned NULL from getpwuid", euid);
+    return(PBSE_IFF_NOT_FOUND);
+    }
+
+  if (strcmp(user_pwd->pw_name, user_name))
+    {
+    sprintf(msg, "User names do not match: submitted: %s, expected: %s", user_name, user_pwd->pw_name);
+    free_pwnam(user_pwd, buf);
+    return(PBSE_IFF_NOT_FOUND);
+    }
+
+  if (pid != user_pid)
+    {
+    sprintf(msg, "invalid pid: submitted: %d, expected: %d", user_pid, pid);
+    free_pwnam(user_pwd, buf);
+    return(PBSE_IFF_NOT_FOUND);
+    }
+
+  ucred_free(cr);
+#else
   cr_size = sizeof(struct ucred);
   if (getsockopt(sock, SOL_SOCKET, SO_PEERCRED, (void *)&cr, &cr_size) < 0)
     {
@@ -688,6 +746,7 @@
     free_pwnam(user_pwd, buf);
     return(PBSE_IFF_NOT_FOUND);
     }
+#endif
 
   free_pwnam(user_pwd, buf);
   return(PBSE_NONE);
--- torque-6.1.0.orig/src/lib/Liblog/pbs_log.c	2017-01-20 20:33:26.170998553 +0100
+++ torque-6.1.0/src/lib/Liblog/pbs_log.c	2017-01-21 01:44:37.350422914 +0100
@@ -145,7 +145,11 @@
 static int      syslogopen = 0;
 #endif /* SYSLOG */
 
+#if defined(__sun) && defined(__SVR4)
+pthread_mutex_t log_mutex = PTHREAD_MUTEX_INITIALIZER;
+#else
 pthread_mutex_t log_mutex = PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP;
+#endif
 
 /* variables for job logging */
 static int      job_log_auto_switch = 0;
@@ -780,7 +784,11 @@
   int eventclass = 0;
   char time_formatted_str[64];
 
+#if defined(__sun) && defined(__SVR4)
+  thr_id = pthread_self();
+#else
   thr_id = syscall(SYS_gettid);
+#endif
   pthread_mutex_lock(&log_mutex);
 
 #if SYSLOG
@@ -856,7 +864,7 @@
       if (eventclass != PBS_EVENTCLASS_TRQAUTHD)
         {
         rc = fprintf(logfile,
-              "%02d/%02d/%04d %02d:%02d:%02d.%03d;%02d;%10.10s.%d;%s;%s;%s%.*s\n",
+              "%02d/%02d/%04d %02d:%02d:%02d.%03d;%02d;%10.10s.%ld;%s;%s;%s%.*s\n",
               ptm->tm_mon + 1,
               ptm->tm_mday,
               ptm->tm_year + 1900,
--- torque-6.1.0.orig/src/lib/Libnet/lib_net.h	2017-01-20 20:33:26.172064578 +0100
+++ torque-6.1.0/src/lib/Libnet/lib_net.h	2017-01-21 01:44:37.350638337 +0100
@@ -60,7 +60,7 @@
 int start_listener_addrinfo(char *host_name, int server_port, void *(*process_meth)(void *));
 
 /* from file net_client.c */
-#ifdef __APPLE__
+#if defined(__APPLE__) || defined(__sun)
 int bindresvport(int sd, struct sockaddr_in *sin);
 #endif
 int get_max_num_descriptors(void);
--- torque-6.1.0.orig/src/lib/Libnet/net_client.c	2017-01-20 20:33:26.172145203 +0100
+++ torque-6.1.0/src/lib/Libnet/net_client.c	2017-01-21 01:44:37.350945577 +0100
@@ -105,6 +105,95 @@
    the function works fine but its use will generate a compiler warning
    if -Wall is used with gcc */
 int bindresvport(int sd, struct sockaddr_in *sin);
+#elif defined(__sun) && defined(__SVR4)
+#include <sys/types.h>
+#include <errno.h>
+#include <sys/socket.h>
+#include <netinet/in.h>
+#include <netinet/tcp.h>
+#include <netinet/udp.h>
+#include <string.h>
+#include <unistd.h>
+
+#define	bzero(s, len)	(void) memset((s), 0, (len))
+
+/*
+ * Bind a socket to a privileged IP port
+ */
+int
+bindresvport(int sd, struct sockaddr_in *sin)
+{
+  struct sockaddr_in myaddr;
+  struct sockaddr_in *bindaddr;
+  int level, optname;
+  int optval, len;
+  int ret;
+
+  bindaddr = sin;
+  if (bindaddr == (struct sockaddr_in *)0) {
+    bindaddr = &myaddr;
+    bzero(bindaddr, sizeof (*bindaddr));
+    bindaddr->sin_family = AF_INET;
+  } else if (bindaddr->sin_family != AF_INET) {
+    errno = EPFNOSUPPORT;
+    return (-1);
+  }
+
+  len = sizeof (optval);
+  if (getsockopt(sd, SOL_SOCKET, SO_TYPE, &optval, (Psocklen_t) &len) < 0) {
+    return (-1);
+  }
+  /*
+   * Use *_ANONPRIVBIND to ask the kernel to pick a port in the
+   * priviledged range for us.
+   */
+  if (optval == SOCK_STREAM) {
+    level = IPPROTO_TCP;
+    optname = TCP_ANONPRIVBIND;
+  } else if (optval == SOCK_DGRAM) {
+    level = IPPROTO_UDP;
+    optname = UDP_ANONPRIVBIND;
+  } else {
+    errno = EPROTONOSUPPORT;
+    return (-1);
+  }
+
+  optval = 1;
+  if (setsockopt(sd, level, optname, &optval, sizeof (optval)) < 0) {
+    return (-1);
+  }
+
+  bindaddr->sin_port = 0;
+  ret = bind(sd, (struct sockaddr *)bindaddr,
+      sizeof (struct sockaddr_in));
+
+  /*
+   * Always turn off the option when we are done.  Note that by doing
+   * this, if the caller has set this option before calling
+   * bindresvport(), it will be unset.  But this should never happen...
+   */
+  optval = 0;
+  (void) setsockopt(sd, level, optname, &optval, sizeof (optval));
+
+  if (ret >= 0 && sin != NULL) {
+    /*
+     * Historical note:
+     *
+     * Past versions of this bindresvport() code have
+     * returned with the reserved port number bound
+     * filled in its "sin" parameter (if passed in), perhaps
+     * "accidently" because of the structure of historical code.
+     *
+     * This is not documented but the behavior is
+     * explicitly retained here for compatibility to minimize
+     * risk to applications, even though it is not clear if this
+     * was a design intent.
+     */
+    len = sizeof (struct sockaddr_in);
+    (void) getsockname(sd, (struct sockaddr *)bindaddr, (Psocklen_t) &len);
+  }
+  return (ret);
+}
 #endif
 
 /**
@@ -218,7 +307,7 @@
 
   len = sizeof(val);
 
-  rc = getsockopt(sockd, SOL_SOCKET, SO_ERROR, &val, &len);
+  rc = getsockopt(sockd, SOL_SOCKET, SO_ERROR, &val, (Psocklen_t) &len);
 
   if ((rc == 0) && (val == 0))
     {
--- torque-6.1.0.orig/src/lib/Libnet/net_common.c	2017-01-20 20:33:26.172858062 +0100
+++ torque-6.1.0/src/lib/Libnet/net_common.c	2017-01-21 01:44:37.351252150 +0100
@@ -28,6 +28,10 @@
 #include "net_cache.h"
 #include "mutex_mgr.hpp"
 
+#if defined(__sun) && defined(__SVR4)
+#include <sys/filio.h>
+#endif
+
 #include "pbs_error.h" /* torque error codes */
 
 #include "lib_ifl.h"
--- torque-6.1.0.orig/src/lib/Libnet/net_server.c	2017-01-20 20:33:26.172588013 +0100
+++ torque-6.1.0/src/lib/Libnet/net_server.c	2017-01-21 01:44:37.351603970 +0100
@@ -920,12 +920,12 @@
   if (sock_type == PBS_SOCK_INET)
     {
     fromsize = sizeof(from);
-    newsock = accept(sd, (struct sockaddr *) & from, &fromsize);
+    newsock = accept(sd, (struct sockaddr *) & from, (Psocklen_t) &fromsize);
     }
   else
     {
     fromsize = sizeof(unixfrom);
-    newsock = accept(sd, (struct sockaddr *) & unixfrom, &fromsize);
+    newsock = accept(sd, (struct sockaddr *) & unixfrom, (Psocklen_t) &fromsize);
     }
 
   if (newsock == -1)
--- torque-6.1.0.orig/src/lib/Libnet/port_forwarding.c	2017-01-20 20:33:26.172668033 +0100
+++ torque-6.1.0/src/lib/Libnet/port_forwarding.c	2017-01-21 01:44:37.351858680 +0100
@@ -103,7 +103,7 @@
           {
           int newsock = 0, peersock = 0;
 
-          if ((sock = accept((socks + n)->sock, (struct sockaddr *) & from, &fromlen)) < 0)
+          if ((sock = accept((socks + n)->sock, (struct sockaddr *) & from, (Psocklen_t) &fromlen)) < 0)
             {
             if ((errno == EAGAIN) || (errno == EWOULDBLOCK) || (errno == EINTR) || (errno == ECONNABORTED))
               continue;
@@ -236,7 +236,7 @@
 
   optlen = sizeof(opt);
 
-  if (getsockopt(fd, IPPROTO_TCP, TCP_NODELAY, &opt, &optlen) == -1)
+  if (getsockopt(fd, IPPROTO_TCP, TCP_NODELAY, &opt, (Psocklen_t) &optlen) == -1)
     {
     fprintf(stderr, "getsockopt TCP_NODELAY: %.100s", strerror(errno));
     return;
--- torque-6.1.0.orig/src/scheduler.cc/pbs_sched.c	2017-01-20 20:33:26.142586596 +0100
+++ torque-6.1.0/src/scheduler.cc/pbs_sched.c	2017-01-21 01:44:37.352190134 +0100
@@ -628,7 +628,7 @@
 
   slen = sizeof(saddr);
 
-  new_socket = accept(sock, (struct sockaddr *) & saddr, &slen);
+  new_socket = accept(sock, (struct sockaddr *) & saddr, (Psocklen_t) &slen);
 
   if (new_socket == -1)
     {
--- torque-6.1.0.orig/src/server/array_func.c	2017-01-20 20:33:25.799219554 +0100
+++ torque-6.1.0/src/server/array_func.c	2017-01-21 01:44:37.352859265 +0100
@@ -1300,8 +1300,8 @@
     {
     return 0;
     }
-  idx = index(str, '-');
-  ridx = rindex(str, '-');
+  idx = strchr(str, '-');
+  ridx = strrchr(str, '-');
 
   /* token is not a range, parse it as a single task id */
   if (idx == NULL)
--- torque-6.1.0.orig/src/server/incoming_request.c	2017-01-20 20:33:25.806126674 +0100
+++ torque-6.1.0/src/server/incoming_request.c	2017-01-21 01:44:37.353177083 +0100
@@ -94,6 +94,10 @@
 #include "net_connect.h"
 #include "batch_request.h"
 
+#if defined(__sun) && defined(__SVR4)
+#undef s_addr
+#endif
+
 const int SHORT_TIMEOUT = 5;
 
 char *netaddr(struct sockaddr_in *ap);
@@ -114,7 +118,7 @@
 
   // we don't want to get all threads stuck polling for input, so make sure that
   // we have a short timeout to start.
-  if (timeout > pbs_incoming_tcp_timeout)
+  if (timeout > (unsigned int) pbs_incoming_tcp_timeout)
     timeout = pbs_incoming_tcp_timeout;
 
   protocol_type = disrui_peek(chan, &rc, timeout);
@@ -123,7 +127,7 @@
     {
     // If we aren't too busy try again. If we are too busy just move on so we
     // don't completely jam ourselves.
-    if ((timeout < pbs_incoming_tcp_timeout) &&
+    if ((timeout < (unsigned int) pbs_incoming_tcp_timeout) &&
         (threadpool_is_too_busy(request_pool, ATR_DFLAG_MGRD) == false))
       {
       chan->IsTimeout = 0;
--- torque-6.1.0.orig/src/server/job_func.c	2017-01-20 20:33:25.805677018 +0100
+++ torque-6.1.0/src/server/job_func.c	2017-01-21 01:44:37.353776704 +0100
@@ -938,8 +938,8 @@
     return(NULL);
     }
 
-  bracket = index(oldid,'[');
-  hostname = index(oldid, '.');
+  bracket = strchr(oldid,'[');
+  hostname = strchr(oldid, '.');
 
   if (bracket != NULL)
     {
--- torque-6.1.0.orig/src/server/node_power_state.c	2017-01-21 01:48:18.876126186 +0100
+++ torque-6.1.0/src/server/node_power_state.c	2016-11-09 21:47:34.000000000 +0100
@@ -196,7 +196,7 @@
       }
 
     int sock;
-    if ((sock = socket(AF_INET,SOCK_PACKET,SOCK_PACKET)) < 0)
+    if ((sock = socket(AF_INET,SOCK_RAW,SOCK_RAW)) < 0)
       {
       return PBSE_SYSTEM;
       }
--- torque-6.1.0.orig/src/server/req_quejob.c	2017-01-20 20:33:25.806608967 +0100
+++ torque-6.1.0/src/server/req_quejob.c	2017-01-21 01:44:37.354379204 +0100
@@ -1854,7 +1854,7 @@
        actions applied to id[] are applied to the entire array */
     oldid = strdup(pj->ji_qs.ji_jobid);
 
-    hostname = index(oldid, '.');
+    hostname = strchr(oldid, '.');
 
     if (hostname != NULL)
       {
--- torque-6.1.0.orig/src/server/req_runjob.c	2017-01-20 20:33:25.804465232 +0100
+++ torque-6.1.0/src/server/req_runjob.c	2017-01-21 01:44:37.354935649 +0100
@@ -1146,7 +1146,7 @@
         char tmpLine[MAXLINE];
         sprintf(tmpLine,
           "Unexpected length for email's text: '%ld' - discarded as a corrupted field",
-          preq->rq_reply.brp_un.brp_txt.brp_txtlen);
+          (long int) preq->rq_reply.brp_un.brp_txt.brp_txtlen);
         log_event(PBSEVENT_JOB, PBS_EVENTCLASS_JOB, job_id, tmpLine);
         }
       }
